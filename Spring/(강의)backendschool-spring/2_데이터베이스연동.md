# 데이터베이스 연동

## JDBC를 이용한 데이터베이스 연동

### JDBC(Java Database Connectivity) 프로그램이란?

- JDBC는 DBMS와의 연동을 위해 제공되는 자바 표준 API(java.sql)이다.

  - 모든 RDB를 동일한 자바로직(코드)로 연결할 수 있는 기술

- JDBC API는 인터페이스를 제공하고 각 DB에서 라이브러리 형태로 자사의 JDBC 구현체를 제공해서 JDBC API를 통해 해당 구현체를 실행시켜 각각에 맞는 DB에 접근하게 되는 방식이다

  

### JDBC 프로그램 절차

1) Driver 로딩

- 드라이버는 java.sql 패키지의 interface를 구현한 클래스이다.
- 해당 드라이버 클래스를 DriverManager에 등록해서 해당 DB에 Connetion을 얻을 수 있다

2) Connetion 연결

- Connetion은 DB와 APP에 연결통로 Conntion을 통해 Statement를 보낼 수 있다

3) Statement 생성

- SQL문을 담고 DB로 전달될 Statement를 생성한다

4) SQL 명령어 전송

- SQL은 String으로 작성하여 변수에 담아 전송한다
- INSERT,UPDATE,DELELTE는 Statemnet.executeUpdate를 사용하고 SELCT의 경우 .executeQuery로 전송하게 된다

5) 검색 결과 처리(INSERT, UPDATE, DELETE 작업에서는 생략)

- ResultSet이란 조회 결과를 담는 Set을 통해 처리하게 된다

6) CONNECTION 연결 해제

- 여러 곳에서 Request가 올때마다 Connetion을 열어둔 채로 두면 중복된 Resource가 사용됨으로 문제가 생길수 있어서 사용후 바로 close를 해주어야 한다
- Conntion 뿐아니라 Statemnet와 ResultSet도 함께 close를 해주어야 한다



### 실습

- H2 데이터베이스 설정 및 라이브러리 등록

  - H2 DB를 다운받고 압축을 풀어 bin/hew.bat을 실행시키면 DB를 실행할 준비가 된다

  - JDBC URL을 jdbc:h2:tcp://localhost/~/test으로 수정해주고 연결을 하면 DB가 구동된다

  - Board Table을 만들고 seq, title, writer, content, regdate, cnt 열을 추가한다

  - 테스 데이터를 추가하고 확인한다

    

- 프로젝트 생성 및 H2 데이터베이스 라이브러리 등록 

  - JDBCProject를 생성하고 ProjectStructure - Libraries - add - h2/bin/h2-1.4.200.jar 파일을 추가한다
  - Project - External Libraries에 jar파일이 추가됬는지 확인한다

- InsertBoardTest

  - Connection conn 과 Statement stmt 변수를 선언하고 null값으로 초기화한다

  - DriverManager.registerDriver(new org.he.Driver()); 을 통해 외부 라이브러리에 등록한 H2 Dirver를 찾아서 등록해준다

    - Class.forName("new org.h2.Driver()")도 위와 같이 등록 해준다
    - SQLException이 발생할 수 있음으로 try~catch문으로 감싸주고 아래 작성될 코드들도 모두 try문 안에 작성한다

  - String url = "jdbc:h2:tcp://localhost/~/test";를 작성하고 conn = DriverManager.getConnction(url, "sa","")을 하여 conntion을 얻는다

    - url은 h2 DB 설정에 입력한 JDBC url을 이용한다
    - getConnetion(URL, ID, PASSWORD)은 h2 DB 설정에서 입력한 url, id, password을 통해 해당 DB에 접근할 Connction을 얻는 것이다

  - stmt= conn.createStatement(); 를통해 connetion에서 Statemnet를 생성할 수 있다

  - String sql ="insert ~"을 통해 SQL문을 담고 int cnt = stmt.executeUpdate(sql); 하여 sql문을 담아 Statement을 전송할 수 있다

    - cnt은 해당 SQL 문 실행에 영향을 받는 행 수를 반환한다

  - Connetion, Statement 모두 리소스를 사용하는 상태로 열려있기 때문에 사용후에는 close를 해주어야 한다

    - 코드를 감싸고 있는 try~catch구문 아래에 finally 구문을 추가한다

    - close하는 순서는 열린 순서에 역순으로 Statement -> Connetion 으로 이어져야 한다

    - 전체의 close를 한번에 try~catch를 하게 되면 앞선 항목이 예외가 발생할시 뒤에 Connetion이 close되지 않을 가능성이 있기 때문에 각각 try~catch를 해준다

      

    

- UpdatedBoardTest

  - InsertBoardTest와 다른 것은 모두 같고 sql만 Update로 바꿔주면 된다

- DeleteBoardTest

  - InsertBoardTest와 다른 것은 모두 같고 sql만 Delete로 바꿔주면 된다

- GetBoardListTest

  - 앞에서 본 Inser, Update, Delete와는 다르게 Select는 조회된 결과를 담는 ResultSet을 사용한다
  - ResultSet rs 변수를 선언하고 null로 초기화한다
  - driver 로딩 Connetion 연결 Statment 생성까지는 위에 과정과 같다
  - Select문을 작성해서 sql에 담아주고 .executeUpdate가 아닌 *.executeQuery*로 실행해주고 그 반환값을 rs 변수에 답는다
    - rs = stmt.executeQuery(sql);
  - 검색 결과 처리를 위해 while(rs.next())를 통해 값을 하나씩 불러서 rs.get자료형("컬럼명")으로 하나씩 불러와서 처리한다
    - whil문을 통해 데이터가 없을때까지 반복해서 출력되어 처리되다가 더이상 값이 없으면 끝난다
      - 좀더 자세히 살펴보면 ResultSet은 첫줄에 Before First, 마지막 줄에 After Last가 있고 그사이에 select된 데이터들이 위치한다
      - 이를 rs.next()를 통해 Before first 다음부터 하나씩 데이터를 가져와서 처리하게 되는데 while문을 통해 rs.next가 AfterLast을 출력하게 되면 데이터가 더이상 없다고 인식하여 whil문이 종료가 된다

- GetBoardTest

  - 다른분은 GetBoardListTest와 똑같이 처리해 주고 while문으로 반복문으로 돌리던 rs.next()를 if 문으로 하나의 데이터만 추출해 상세정보를 출력하도록 검색 결과를 처리합니다

